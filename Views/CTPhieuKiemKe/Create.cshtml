@model KhoHang_XNK.Models.ChiTietPhieuKiemKe

@{
    ViewData["Title"] = "Thêm mới Chi Tiết Phiếu Kiểm Kê";
}

<!--Sidebar-->
<div class="sidebar transition overlay-scrollbars animate__animated  animate__slideInLeft">
	<div class="sidebar-content">
		<div id="sidebar">

			<!-- Logo -->
			<div class="logo">
				<h2 class="mb-0"><img src="~/images/logo/logo_sidebar.png"> WareTrack</h2>
			</div>

			<ul class="side-menu">
				<li>
					<a asp-controller="KhoHang" asp-action="Index">
						<i class='bx bxs-dashboard icon'></i> Kho Hàng
					</a>
				</li>

				<!-- Divider-->
				<li class="divider" data-text="STARTER">Quản lý Hàng hóa</li>

				<li>
					<a asp-controller="HangHoa" asp-action="Index">
						<i class='bx bx-columns icon'></i>
						Hàng Hóa
					</a>
				</li>

				<li>
					<a asp-controller="LoaiHangHoa" asp-action="Index">
						<i class='bx bxs-meh-blank icon'></i>
						Loại Hàng Hóa
					</a>
				</li>

				<li>
					<a asp-controller="TonKho" asp-action="Index">
						<i class='fa fa-th icon'></i>
						Tồn Kho
					</a>
				</li>

				<!-- Divider-->
				<li class="divider" data-text="Atrana">Quản lý Nhân sự và Khách hàng</li>

				<li>
					<a asp-controller="NhanVien" asp-action="Index">
						<i class='bx bxs-user icon'></i>
						Nhân Viên
					</a>
				</li>

				<li>
					<a asp-controller="KhachHang" asp-action="Index">
						<i class='bx bxs-notepad icon'></i>
						Khách Hàng
					</a>
				</li>

				<li>
					<a asp-controller="LoaiKhachHang" asp-action="Index">
						<i class='bx bxs-widget icon'></i>
						Loại Khách Hàng
					</a>
				</li>

				<!-- Divider-->
				<li class="divider" data-text="Pages">Quản lý Nhà cung cấp</li>
				<li>
					<a asp-controller="NhaCungCap" asp-action="Index">
						<i class='fa fa-pencil-ruler icon'></i>
						Nhà Cung Cấp
					</a>
				</li>

				<!-- Divider-->
				<li class="divider" data-text="Pages">Quản lý Nhà cung cấp</li>
				<li>
					<a asp-controller="DonNhapHang" asp-action="Index">
						<i class='bx bxs-notepad icon'></i>
						Đơn Nhập Hàng
					</a>
				</li>
				<li>
					<a asp-controller="DonXuatHang" asp-action="Index">
						<i class='bx bxs-notepad icon'></i>
						Đơn Xuất Hàng
					</a>
				</li>
				<li>
					<a asp-controller="PhieuKiemKe" asp-action="Index" class="active">
						<i class='bx bxs-notepad icon'></i>
						Phiếu Kiểm Kê
					</a>
				</li>
				<li>
					<a asp-controller="ThongKe" asp-action="Index">
						<i class="bx bxs-bar-chart-alt-2 icon"></i>
						Thông Kê Doanh Thu
					</a>
				</li>
			</ul>
		</div>
	</div>
</div>
<!-- End Sidebar-->

<div class="sidebar-overlay"></div>

<!--Content Start-->
<div class="content-start transition">
	<div class="container-fluid dashboard">
		<div class="card shadow-lg p-4">
			<div class="card-body">
				@* <form asp-action="Create" method="post"> *@
				@* 	<div asp-validation-summary="ModelOnly" class="alert alert-danger d-none"></div> *@

				@* 	<!-- Mã Kiểm Kê --> *@
				@* 	<div class="mb-3"> *@
				@* 		<label asp-for="MaKiemKe" class="form-label fw-bold">Mã Kiểm Kê</label> *@
				@* 		<select asp-for="MaKiemKe" id="MaKiemKe" class="form-select" asp-items="ViewBag.MaKiemKe"> *@
				@* 			<option value="">-- Chọn Mã Kiểm Kê --</option> *@
				@* 		</select> *@
				@* 		<span asp-validation-for="MaKiemKe" class="text-danger"></span> *@
				@* 	</div> *@

				@* 	<!-- Mã Hàng Hóa --> *@
				@* 	<div class="mb-3"> *@
				@* 		<label asp-for="MaHangHoa" class="form-label fw-bold">Mã Hàng Hóa</label> *@
				@* 		<select asp-for="MaHangHoa" id="MaHangHoa" class="form-select" asp-items="ViewBag.MaHangHoa"> *@
				@* 			<option value="">-- Chọn Hàng Hóa --</option> *@
				@* 		</select> *@
				@* 		<span asp-validation-for="MaHangHoa" class="text-danger"></span> *@
				@* 	</div> *@

				@* 	<!-- Số lượng tồn kho (hiển thị tự động) --> *@
				@* 	<div class="mb-3"> *@
				@* 		<label class="form-label fw-bold">Số Lượng Tồn Kho</label> *@
				@* 		<input id="soLuongTonKho" class="form-control" type="number" readonly value="0" /> *@
				@* 	</div> *@

				@* 	<!-- Số Lượng Thực Tế --> *@
				@* 	<div class="mb-3"> *@
				@* 		<label asp-for="SoLuongThucTe" class="form-label fw-bold">Số Lượng Thực Tế</label> *@
				@* 		<input asp-for="SoLuongThucTe" id="SoLuongThucTe" class="form-control" placeholder="Nhập số lượng thực tế" /> *@
				@* 		<span asp-validation-for="SoLuongThucTe" class="text-danger"></span> *@
				@* 	</div> *@

				@* 	<!-- Số Lượng Chênh Lệch --> *@
				@* 	<div class="mb-3"> *@
				@* 		<label asp-for="SoLuongChenhLech" class="form-label fw-bold">Số Lượng Chênh Lệch</label> *@
				@* 		<input asp-for="SoLuongChenhLech" id="SoLuongChenhLech" class="form-control" placeholder="Nhập số lượng chênh lệch" /> *@
				@* 		<span asp-validation-for="SoLuongChenhLech" class="text-danger"></span> *@
				@* 	</div> *@

				@* 	<!-- Nút thao tác --> *@
				@* 	<div class="d-flex justify-content-between"> *@
				@* 		<a asp-action="Index" class="btn btn-secondary"> *@
				@* 			<i class="fas fa-arrow-left"></i> Quay lại *@
				@* 		</a> *@
				@* 		<button type="submit" class="btn btn-primary"> *@
				@* 			<i class="fas fa-save"></i> Lưu *@
				@* 		</button> *@
				@* 	</div> *@
				@* </form> *@
				<form asp-action="Create" method="post">
					<div asp-validation-summary="ModelOnly" class="alert alert-danger d-none"></div>

					<!-- Mã Kiểm Kê -->
					<div class="mb-3">
						<label asp-for="MaKiemKe" class="form-label fw-bold">Mã Kiểm Kê</label>
						<select asp-for="MaKiemKe" class="form-select" asp-items="ViewBag.MaKiemKe" id="maKiemKeSelect">
							<option value="">-- Chọn Mã Kiểm Kê --</option>
						</select>
						<span asp-validation-for="MaKiemKe" class="text-danger"></span>
					</div>

					<!-- Mã Hàng Hóa -->
					<div class="mb-3">
						<label asp-for="MaHangHoa" class="form-label fw-bold">Mã Hàng Hóa</label>
						<select asp-for="MaHangHoa" class="form-select" asp-items="ViewBag.MaHangHoa" id="maHangHoaSelect">
							<option value="">-- Chọn Hàng Hóa --</option>
						</select>
						<span asp-validation-for="MaHangHoa" class="text-danger"></span>
					</div>

					<!-- Số Lượng Tồn Kho (chỉ hiển thị) -->
					<div class="mb-3">
						<label class="form-label fw-bold">Số Lượng Tồn Kho</label>
						<input type="text" class="form-control" id="soLuongTonKho" readonly placeholder="Số lượng tồn kho sẽ hiển thị ở đây" />
					</div>

					<!-- Số Lượng Thực Tế -->
					<div class="mb-3">
						<label asp-for="SoLuongThucTe" class="form-label fw-bold">Số Lượng Thực Tế</label>
						<input asp-for="SoLuongThucTe" class="form-control" placeholder="Nhập số lượng thực tế" />
						<span asp-validation-for="SoLuongThucTe" class="text-danger"></span>
					</div>

					<!-- Số Lượng Chênh Lệch -->
					<div class="mb-3">
						<label asp-for="SoLuongChenhLech" class="form-label fw-bold">Số Lượng Chênh Lệch</label>
						<input asp-for="SoLuongChenhLech" class="form-control" placeholder="Nhập số lượng chênh lệch" />
						<span asp-validation-for="SoLuongChenhLech" class="text-danger"></span>
					</div>

					<!-- Nút thao tác -->
					<div class="d-flex justify-content-between">
						<a asp-action="Index" class="btn btn-secondary">
							<i class="fas fa-arrow-left"></i> Quay lại
						</a>
						<button type="submit" class="btn btn-primary">
							<i class="fas fa-save"></i> Lưu
						</button>
					</div>
				</form>
			</div>
		</div>

	</div>
</div>

@section Scripts {
	<script>
		$(document).ready(function() {
			// Debug: Log khi trang được tải
			console.log("Trang đã sẵn sàng");

			// Xử lý khi chọn hàng hóa
			$('#maHangHoaSelect').change(function() {
				var maHangHoa = $(this).val();
				var maKiemKe = $('#maKiemKeSelect').val();

				// Debug: Log giá trị đã chọn
				console.log("Mã hàng hóa:", maHangHoa, "Mã kiểm kê:", maKiemKe);

				if (maHangHoa && maKiemKe) {
					// Gọi API để lấy số lượng tồn kho
					$.get('/CTPhieuKiemKe/GetTonKho', {
						maHangHoa: maHangHoa,
						maKiemKe: maKiemKe
					})
					.done(function(data) {
						// Debug: Log kết quả từ server
						console.log("Kết quả từ API:", data);

						if (data.success) {
							$('#soLuongTonKho').val(data.soLuong);

							// Tự động tính chênh lệch nếu có số lượng thực tế
							if ($('#SoLuongThucTe').val()) {
								calculateChenhLech();
							}
						} else {
							$('#soLuongTonKho').val("Lỗi: " + data.message);
						}
					})
					.fail(function(error) {
						// Debug: Log lỗi từ API
						console.error("Lỗi khi gọi API:", error);
						$('#soLuongTonKho').val("Không thể kết nối đến server");
					});
				} else {
					$('#soLuongTonKho').val('');
				}
			});

			// Xử lý khi thay đổi mã kiểm kê
			$('#maKiemKeSelect').change(function() {
				// Kích hoạt lại sự kiện change của mã hàng hóa
				$('#maHangHoaSelect').trigger('change');
			});

			// Tự động tính số lượng chênh lệch khi nhập số lượng thực tế
			$('#SoLuongThucTe').on('input', function() {
				calculateChenhLech();
			});

			// Hàm tính chênh lệch
			function calculateChenhLech() {
				var soLuongTonKho = parseInt($('#soLuongTonKho').val()) || 0;
				var soLuongThucTe = parseInt($('#SoLuongThucTe').val()) || 0;
				var chenhLech = soLuongThucTe - soLuongTonKho;

				$('#SoLuongChenhLech').val(chenhLech);
			}
		});
	</script>
}